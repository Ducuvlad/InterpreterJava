import Controller.ControllerException;
import Controller.InterpreterController;
import Model.Expression.ArithExp;
import Model.Expression.ConstExp;
import Model.Expression.VarExp;
import Model.ProgramState;
import Model.Statement.*;
import Model.Utils.*;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;

import java.io.BufferedReader;
import java.util.*;

public class Gui {
    private InterpreterController c1;
    private InterpreterController c2;
    private CompoundStm cs1;
    private IfStm is1;
    private List<ProgramState> prgList;
    private InterpreterController currentController;
    public Gui(){
        c1=new InterpreterController("C:\\Users\\Printu Marnii\\Desktop\\hw2\\src\\logFile.txt");
        cs1=new CompoundStm(new OpenRFile(1,"C:\\Users\\Printu Marnii\\Desktop\\hw2\\src\\test.in"),
                new CompoundStm(new ReadFile(1,"c"),
                        new CompoundStm(new PrintStm(new VarExp("c")),
                                new CompoundStm(new IfStm(new VarExp("c"),
                                        new CompoundStm(new ReadFile(1,"c"),new PrintStm(new VarExp("c"))),new PrintStm(new ConstExp(0))),
                                        new CloseRFile(1)))));
        c1.addCompoundStatement(cs1);

        c2=new InterpreterController("C:\\Users\\Printu Marnii\\Desktop\\hw2\\src\\logFile.txt");
        is1=new IfStm(new ConstExp
                (10),
                new CompoundStm(new AssignmentStm("v", new
                        ConstExp(5)), new PrintStm(new
                        ArithExp( new ConstExp(3),
                        new
                                ConstExp(3), '/'))), new PrintStm
                (new ConstExp(100)));
        c2.addIfStm(is1);

    }
    @FXML
    private ListView<String> lis;

    @FXML
    private TextField nrOfPrgStField;

    @FXML
    private TableView<NewPair> heapTable;

    @FXML
    private TableColumn<NewPair,Integer> addCol;

    @FXML
    private TableColumn<NewPair,Integer> heapValCol;

    @FXML
    private ListView<String> outList;

    @FXML
    private TableView<IntStringPair> fileTable;

    @FXML
    private TableColumn<IntStringPair,Integer> identCol;

    @FXML
    private TableColumn<IntStringPair,String> fNameCol;

    @FXML
    private TableView<IntStringPair> symTable;

    @FXML
    private TableColumn<IntStringPair,String> vNameCol;

    @FXML
    private TableColumn<IntStringPair,Integer> symValCol;

    @FXML
    private ListView<String> exeStack;

    @FXML
    private ListView<String> prgStateIds;

    @FXML
    public void initialize() {
        addCol.setCellValueFactory(new PropertyValueFactory<>("int1"));
        heapValCol.setCellValueFactory(new PropertyValueFactory<>("int2"));
        identCol.setCellValueFactory(new PropertyValueFactory<>("in"));
        fNameCol.setCellValueFactory(new PropertyValueFactory<>("st"));
        vNameCol.setCellValueFactory(new PropertyValueFactory<>("st"));
        symValCol.setCellValueFactory(new PropertyValueFactory<>("in"));
        ObservableList<String> items = FXCollections.observableArrayList (
                cs1.toString(),is1.toString());
        lis.setItems(items);
    }



    public void setController(){
        String s=lis.getSelectionModel().getSelectedItem();
        if(s.equals(cs1.toString())){
            currentController=c1;
        }
        else if(s.equals(is1.toString())){
            currentController=c2;
        }
        else {
            currentController=null;
        }
    }

    public void selectedProgram(){
        if(currentController!=null) {
            if(prgStateIds.getSelectionModel().getSelectedItem()!=null) {
                Integer id = Integer.parseInt(prgStateIds.getSelectionModel().getSelectedItem());
                if (prgList.size() != 0) {
                    ProgramState currentProgram = currentController.getRepo().getProgram(id);
                    if (currentProgram != null) {
                        Set<Map.Entry<String, Integer>> st = new HashMap<>(currentProgram.getSymTable().getContent()).entrySet();
                        ArrayList<IntStringPair> arlis = new ArrayList<>();
                        for (Map.Entry<String, Integer> ent : st) {
                            arlis.add(new IntStringPair(ent.getKey(), ent.getValue()));
                        }
                        ObservableList<IntStringPair> itemis = FXCollections.observableArrayList(
                                arlis);
                        symTable.setItems(itemis);

                        Stack<IStatement> stack=currentProgram.getExeStack().getStack();
                        ArrayList<String> al=new ArrayList<>();
                        for(IStatement t:stack){
                            al.add(t.toString());
                        }
                        ObservableList<String> items = FXCollections.observableArrayList(
                                al);
                        exeStack.setItems(items);
                    }
                }
                else {
                    symTable.getItems().clear();
                    exeStack.getItems().clear();
                }
            }
        }
    }

    public void oneStep(){
        if(currentController!=null) {
            try {
                prgList = currentController.removeCompletedPrg(currentController.getRepo().getPrgList());
                if (prgList.size() != 0) {
                    currentController.oneStepForAllPrg(prgList);
                    nrOfPrgStField.setText(currentController.nrOfPrgStates().toString());
                    MyList<Integer> out = currentController.getRepo().getPrgList().get(0).getOutput();
                    ObservableList<String> items = FXCollections.observableArrayList(
                            out.toString());
                    outList.setItems(items);
                    int i = prgList.size();
                    ArrayList<String> idlis = new ArrayList<>();
                    while (i > 0) {
                        idlis.add(prgList.get(i - 1).getId().toString());
                        i -= 1;
                    }
                    items = FXCollections.observableArrayList(idlis);
                    prgStateIds.setItems(items);
                    prgList = currentController.removeCompletedPrg(currentController.getRepo().getPrgList());

                    if(prgList.size()!=0) {
                        Set<Map.Entry<Integer, Integer>> heap = new HashMap<>(prgList.get(prgList.size() - 1).getHeap().getContent()).entrySet();
                        ArrayList<NewPair> arlis = new ArrayList<>();
                        for (Map.Entry<Integer, Integer> ent : heap) {
                            arlis.add(new NewPair(ent.getKey(), ent.getValue()));
                        }
                        ObservableList<NewPair> itemis = FXCollections.observableArrayList(
                                arlis);
                        heapTable.setItems(itemis);
                    }

                    if(prgList.size()!=0) {
                        Set<Map.Entry<Integer, Pair<String, BufferedReader>>> ft = new HashMap<>(prgList.get(prgList.size() - 1).getFileTable().getContent()).entrySet();
                        ArrayList<IntStringPair> arlis = new ArrayList<>();
                        for (Map.Entry<Integer, Pair<String, BufferedReader>> ent : ft) {
                            arlis.add(new IntStringPair(ent.getKey(), ent.getValue().x));
                        }
                        ObservableList<IntStringPair> itemis = FXCollections.observableArrayList(
                                arlis);
                        fileTable.setItems(itemis);
                    }



                } else {
                    nrOfPrgStField.setText("0");
                    prgStateIds.getItems().clear();
                    outList.getItems().clear();
                    fileTable.getItems().clear();
                    heapTable.getItems().clear();
                }
            } catch (ControllerException ce) {
                System.out.println(ce.toString());
            }
        }
        else{
            System.out.println("Bad!");
        }

    }

}